System.register(["jimu-core","jimu-arcgis","jimu-ui","esri/widgets/UtilityNetworkTrace","esri/core/reactiveUtils"],(function(e,t){var i={},a={},s={},n={},o={};return{setters:[function(e){i.DataRecordsSelectionChangeMessage=e.DataRecordsSelectionChangeMessage,i.DataSourceManager=e.DataSourceManager,i.Immutable=e.Immutable,i.MessageManager=e.MessageManager,i.React=e.React,i.css=e.css,i.jsx=e.jsx},function(e){a.JimuMapViewComponent=e.JimuMapViewComponent,a.MapViewManager=e.MapViewManager},function(e){s.WidgetPlaceholder=e.WidgetPlaceholder},function(e){n.default=e.default},function(e){o.default=e.default}],execute:function(){e((()=>{var e={16733:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="M5 2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Zm-1 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM5 12.5a2.5 2.5 0 1 1-.703-1.739l1.86-1.389A2.5 2.5 0 1 1 10.95 8h2.099a2.5 2.5 0 0 1 2.75-1.982l.447-1.354A2.5 2.5 0 0 1 17.5 0a2.5 2.5 0 1 1-.304 4.982l-.447 1.352a2.5 2.5 0 0 1-.352 4.5l.924 3.172a2.5 2.5 0 1 1-.963.27l-.954-3.278A2.501 2.501 0 0 1 13.05 9h-2.1A2.503 2.503 0 0 1 9 10.95v4.1a2.5 2.5 0 1 1-1 0v-4.1a2.496 2.496 0 0 1-1.312-.727l-1.852 1.384c.106.277.164.578.164.893Zm-1 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM8.5 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm1.5 7.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm7.5.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM17 8.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm.5-4.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd"></path><path fill="#000" d="M3 7V6H2v1h1ZM3 8v1H2V8h1ZM3 17v-1H2v1h1ZM2 18h1v1H2v-1Z"></path></svg>'},135:e=>{"use strict";e.exports=o},88275:e=>{"use strict";e.exports=n},26826:e=>{"use strict";e.exports=a},48891:e=>{"use strict";e.exports=i},30726:e=>{"use strict";e.exports=s}},t={};function r(i){var a=t[i];if(void 0!==a)return a.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="";var l={};return r.p=window.jimuConfig.baseUrl,(()=>{"use strict";r.r(l),r.d(l,{__set_webpack_public_path__:()=>p,default:()=>h});var e=r(48891),t=r(26826),i=r(30726),a=r(88275),s=r(135),n=function(e,t,i,a){return new(i||(i=Promise))((function(s,n){function o(e){try{l(a.next(e))}catch(e){n(e)}}function r(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}l((a=a.apply(e,t||[])).next())}))};class o{constructor(){this.unt=null,this.props=null,this.mvManager=t.MapViewManager.getInstance()}static getInstance(){return o.instance||(o.instance=new o),o.instance}loadPropsFromView(e){this.props=e}loadTraceWidgetFromAPI(e,t){return n(this,void 0,void 0,(function*(){null!==this.unt&&null!==this.unt.viewModel&&this.unt.viewModel.reset();let i=null;e.view.map.utilityNetworks&&(i=e.view.map.utilityNetworks.getItemAt(0));const s=new a.default({container:t,utilityNetwork:i,view:e.view,showSelectionAttributes:!0,selectOnComplete:!0,showGraphicsOnComplete:!0,selectedTraces:[],flags:[],enableResultArea:!1});return this.unt=s,yield this.loadAllChildDS(),this.registerEvents(),s}))}registerEvents(){this.unt.on("select-features",(t=>{this.clearSelection(t);const i=this.getActiveMap().jimuLayerViews,a=e.DataSourceManager.getInstance(),s={};t.resultSet.forEach((e=>{e.forEach((e=>{for(const t in i){const n=a.getDataSource(i[t].layerDataSourceId);if(n&&"FEATURE_LAYER"===n.type&&n.layer.id===e.layer.id){const i=e.layer.objectIdField;s[t]||(s[t]={ds:n,featDatRecList:[],objectIdList:[]}),e.featureSet.features.forEach((e=>{s[t].featDatRecList.push(n.buildRecord(e)),s[t].objectIdList.push(e.attributes[i])}))}}}))}));for(const t in s){s[t].ds.selectRecordsByIds(s[t].objectIdList.map(String),s[t].featDatRecList,!0);const i=new e.DataRecordsSelectionChangeMessage(this.props.id,s[t].featDatRecList);e.MessageManager.getInstance().publishMessage(i)}})),this.unt.on("clear-selection",(e=>{this.unt&&this.clearSelection(e)}));const t=this.getFeatureLayerDS();null!==t&&(this.unt.gdbVersion=t.getGDBVersion(),s.default.watch((()=>t.layer.gdbVersion),(e=>{this.unt.gdbVersion=e})))}clearSelection(t){const i=this.getActiveMap();if(null!==i){const a=i.jimuLayerViews,s=e.DataSourceManager.getInstance();if(t.resultSet.length>0){const e=[];for(const t in a){if(!e.includes(a[t].layerDataSourceId)){const e=s.getDataSource(a[t].layerDataSourceId);e&&"FEATURE_LAYER"===e.type&&e.clearSelection()}e.push(a[t].layerDataSourceId)}}else for(const e in a){const t=s.getDataSource(a[e].layerDataSourceId);t&&"FEATURE_LAYER"===t.type&&t.clearSelection()}}}clearAll(){let t=null;this.mvManager.getAllJimuMapViewIds().forEach((i=>{const a=this.mvManager.getJimuMapViewById(i);if(t=a,null!==t){const i=e.DataSourceManager.getInstance(),a=t.jimuLayerViews;for(const e in a){const t=i.getDataSource(a[e].layerDataSourceId);t&&"FEATURE_LAYER"===t.type&&t.clearSelection()}t.view.graphics.removeAll(),this.callResetOnJSWidget()}}))}callResetOnJSWidget(){null!==this.unt&&null!==this.unt.viewModel&&null!==this.unt.viewModel._unObject&&this.unt.viewModel.reset()}getActiveMap(){let e=null;if(this.props&&this.props.config.useMapWidget){const t=this.mvManager.getJimuMapViewGroup(this.props.config.useMapWidgetIds);if(t&&t.jimuMapViews)for(const i in t.jimuMapViews)t.jimuMapViews[i].dataSourceId&&(t.jimuMapViews[i].isActive||void 0===t.jimuMapViews[i].isActive)&&(e=t.jimuMapViews[i])}return e}getFeatureLayerDS(){const t=this.getActiveMap();if(null!==t){const i=t.jimuLayerViews,a=e.DataSourceManager.getInstance();for(const e in i){const t=a.getDataSource(i[e].layerDataSourceId);if(!t)return null;if("FEATURE_LAYER"===t.type){const e=t;if(e.getLayerDefinition().fields.some((e=>"subnetworkname"===e.name.toLowerCase())))return e}}return null}return null}loadAllChildDS(){return n(this,void 0,void 0,(function*(){const t=this.getActiveMap();if(t){yield t.whenAllJimuLayerViewLoaded();const i=e.DataSourceManager.getInstance().getDataSource(t.dataSourceId);return i.isDataSourceSet&&!i.areChildDataSourcesCreated()&&(yield i.childDataSourcesReady()),!0}return!1}))}}function c(t,i){const a=t.surfaces[1].bg;return e.css`
    overflow: auto;
    width: 100%;
    height: 100%;
    background-color: ${a};
    .widget-utility-trace {
      width: 100%;
      height: 100%;
      background-color: ${a};
    }
  `}var u=r(16733),d=r.n(u);class h extends e.React.PureComponent{constructor(t){super(t),this.containerRef=e.React.createRef(),this.viewModel=o.getInstance(),this.defaultColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"},this.onActiveViewChange=e=>{this.viewModel.loadPropsFromView(this.props),null!==e?(this.state.unt&&null!==this.state.unt&&(null!==this.state.unt.viewModel.utilityNetwork?(this.viewModel.clearAll(),this.state.unt.destroy()):this.state.unt.destroy()),this.setState({},(()=>{return t=this,i=void 0,s=function*(){const t=document.createElement("div");t.className="trace-container",this.containerRef.current.innerHTML="",this.containerRef.current.appendChild(t);const i=yield this.viewModel.loadTraceWidgetFromAPI(e,t);this.setState({unt:i,jmv:e},(()=>{this.viewModel.loadAllChildDS()}))},new((a=void 0)||(a=Promise))((function(e,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof a?i:new a((function(e){e(i)}))).then(o,r)}l((s=s.apply(t,i||[])).next())}));var t,i,a,s}))):(this.state.unt&&(null!==this.state.unt&&null!==this.state.unt.viewModel.utilityNetwork?(this.viewModel.callResetOnJSWidget(),this.viewModel.clearAll(),this.state.unt.destroy()):this.state.unt.destroy()),this.setState({unt:null,jmv:null}))},this.componentWillUnmount=()=>{this.viewModel.clearAll()},this.state={jmv:null,unt:null,hasMapWidget:!!this.props.config.useMapWidget&&this.props.config.useMapWidget}}componentDidUpdate(t,i){if(window.jimuConfig.isInBuilder)if(null!==this.state.jmv){if(null!==this.state.unt){const t=[],i=[];Object.prototype.hasOwnProperty.call(this.props.config,"configInfo")&&(this.props.config.configInfo.forEach((a=>{a.traceSettings.forEach((e=>{e.selected&&t.push(e.globalId)})),a.inputSettings.length>0&&a.inputSettings.forEach((t=>{const a=e.Immutable.asMutable((0,e.Immutable)(t.inputSymbol),{deep:!0});delete a.defaultPointSymbol.imageData,a.defaultPointSymbol.type="picture-marker",i.push({label:t.label,description:t.description,type:t.type,symbol:a.defaultPointSymbol})}))})),this.props.config.useMapWidget?this.setState({unt:this.state.unt,hasMapWidget:!0}):this.onActiveViewChange(null))}}else this.setState({hasMapWidget:!1},(()=>{this.viewModel.callResetOnJSWidget(),this.viewModel.clearAll()}))}componentDidMount(){}render(){var a;return(0,e.jsx)("div",{css:c(this.props.theme,this.props.config),id:this.props.widgetId+"_trace_widget"},(0,e.jsx)("div",{ref:this.containerRef,css:this.state.hasMapWidget?e.css`
    height: 100%;
  `:""}),this.state.hasMapWidget?"":(0,e.jsx)(i.WidgetPlaceholder,{icon:d(),message:this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:"Utility Network Trace"}),widgetId:this.props.id}),this.props.config.useMapWidget&&(0,e.jsx)(t.JimuMapViewComponent,{useMapWidgetId:null===(a=this.props.useMapWidgetIds)||void 0===a?void 0:a[0],onActiveViewChange:this.onActiveViewChange}))}}function p(e){r.p=e}})(),l})())}}}));